<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
			body {
				background: #FFFFFF;
			}
			
			.mui-bar {
				background: #6bbb55;
				color: #fff;
			}
			
			header .mui-title {
				color: #fff;
			}
			
			header .mui-icon-left-nav {
				color: #fff;
			}
			
			header button {
				color: #fff !important;
			}
			label{
				margin: 0;
				padding: 0;
			}
			
			.mui-content {
				background: #FFFFFF;
			}
			.verContent{
				width: 100%;
				height: 50px;
				margin-top: 20px;
			}
			.phoneYanZheng_ver{
				display: inline-block;
				margin-left: 3%;
				margin-right: 10px;
				width: 60%;
				height: 50px;
				background: #f2f2f2;
				line-height: 50px;
			}
			.phoneYanZheng_ver label{
				margin-left: 5px;
				font-size: 14px;
			}
			.phoneYanZheng_ver input{
				width: 70%;
				margin: 0;
				font-size: 15px;
				border: 0;
				background: #f2f2f2;
				height:30px;
				line-height: 30px;
				padding-top:10px;
			}
			.sendVer{
				display: inline-block;
				width: 29%;
				height: 50px;
				margin-right:3% ;
				float: right;
				text-align: center;
				line-height: 50px;
				background: #d9d9d9;
				color: #FFFFFF;
				font-size: 15px;
			}
			.click_sure{
				width: 90%;
				height: 50px;
				margin-top: 15px;
				margin-left: 5%;
				font-size: 17px;
				text-align: center;
				color: #FFFFFF;
				background: #d9d9d9;
				border: 0;
			}
			.mui-checkbox input[type=checkbox]:checked:before,
			.mui-radio input[type=radio]:checked:before {
				color: #6bbb55;
			}
			.mui-input-row{
				margin-top: 30px;
				margin-left: 3%;
				width: 94%;
				height: 50px;
				background: #f2f2f2;
				line-height: 50px;
			}
			.mui-input-row label{
				margin-left: 5px;
				font-size: 14px;
				width: 45px;
				padding: 0;
				line-height: 50px;
			}
			.mui-input-row label~input, .mui-input-row label~select, .mui-input-row label~number {
			    width: 65%;
			    float: left;
			    margin-bottom: 0;
			    padding-left: 0;
			    border: 0;
			    font-size: 14px;
			    /*line-height: 15px;*/
			    /*padding-top: 4px;
			    padding-left:18px;*/
		    }
			.mui-input-row input{
				width: 70%;
				margin: 0;
				/*margin-top: 10px;
				padding-top: 1px;*/
				font-size: 14px;
				/*line-height: 15px;*/
				border: 0;
				background: #f2f2f2;
			}
			.mui-input-row .mui-input-clear~.mui-icon-clear, .mui-input-row .mui-input-password~.mui-icon-eye, .mui-input-row .mui-input-speech~.mui-icon-speech {
			    font-size: 20px;
			    position: absolute;
			    z-index: 1;
			    top: 17px;
			    right: 0;
			    width: 38px;
			    height: 38px;
			    text-align: center;
			    color: #999;
			}
			
			.mui-backdrop {
				position: fixed;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				z-index: 998;
				background-color: rgba(0,0,0,.3);
			}
			
			#user_name{
				margin: 0;
				padding: 0;
				outline: 0;
				border: none;
				height:22px;
				line-height: 22px;
				margin-top:16px;
				margin-left: 12px;
				font-size: 14px;
				line-height: normal !important;
			}
			
			#yanZhen{
				margin: 0;
				padding: 0;
				outline: 0;
				border: none;
				height:22px;
				line-height: 22px;
				margin-top:15px;
				margin-left: 12px;
				font-size: 14px;
				width: 60%;
				display: inline-block;
				line-height: normal !important;
			}
			.voiceMsgBtn{
				color: #6bbb55;
			    font-size: 12px;
			    margin-left: 15px;
			    margin-top: 15px;
			    padding: 5px;
			    display: inline-block;
			}
		</style>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<button class="mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left"><span class="mui-icon mui-icon-left-nav"></span>返回</button>
			<h1 class="mui-title">手机验证</h1>
		</header>
		<div class="mui-content">
			<div class="mui-input-row">
		        <label>手机号</label>
		    	<input type="number" class="mui-input-clear" placeholder="请输入手机号" id="user_name">
		    </div>
			<div class="verContent">
				<div class="phoneYanZheng_ver">
					<label style = "height:50px;line-height:50px;display: inline-block;">验证码</label>
					<input style = "" type="number" id = "yanZhen" placeholder="请输入验证码" />
				</div>
				<div class="sendVer">
					获取验证码
				</div>
			</div>
			<p class = "voiceMsgBtn">收不到短信，试试语音验证码</p>
			<button class="click_sure">确定</button>
			<div  style="margin-top: 10px;border: 0;">
				<p style="margin-top: 2px;font-size: 12px;text-align: left;margin-left: 12%;">
					点击确定，即表示我已阅读并同意
					<a style="color: #6bbb55;margin-left: 5px;" href="javascript:goPage('TermOfService.html')">《用车服务条款》</a>
				</p>
				<!--<input name="checkbox1" value="Item 1" type="checkbox" checked>-->
			</div>
		</div>
	</body>
	<script src="js/mui.min.js"></script>
	<script type="text/javascript" src="js/click.js" ></script>
	<script type="text/javascript" src="js/jquery-2.2.0.min.js" ></script>
	<script type="text/javascript" src="js/base.js" ></script>
	<script>
	 	var countdown;

		$(".mui-input-row input").keyup(function() {
			var value = $(".mui-input-row input").val();
			var ph = value.length;
			if(ph == 11) {
				$(".sendVer").css("background", "#6bbb55");
			} else {
				$(".sendVer").css("background", "#DDDDDD");
			}
		});
		//语音短信发送触发事件
		$(".voiceMsgBtn").click(function(){
			var self = $(this);
			var mobile = $(".mui-input-row input").val();
			var textMsg= $(".sendVer").text();
			if(mobile.length != 11){
				plus.nativeUI.toast("请先填写正确的手机号");
				return false;
			}
			if(textMsg.trim() != "获取验证码" && textMsg.trim() != "重新发送"){
				plus.nativeUI.toast("短信验证码正在发送中，请等计时结束后再尝试发送语音短信");
				return false;
			}
			if(self.hasClass("countDown")){
				plus.nativeUI.toast("语音验证码不能一分钟内重复发送");
				return false;
			}
			$.ajax({
				type: "post",
				url: IP + "/mobile/userSendVoiceMsg",
				data: {
					phone: mobile
				},
				dataType:"json",
				success: function(data) {
					if(data.result == 'success') {
						plus.nativeUI.toast("语音验证码已发送");
						self.addClass("countDown");
						setTimeout(function(){
							self.removeClass("countDown");
						},6000);
					} else {
						plus.nativeUI.alert(data.result, function() {}, "出错了", "知道了")
					}
				},error:function(){
					plus.nativeUI.toast("语音验证码已发送");
				}
			});
		});
		$(".sendVer").click(function() {
			var mobile = $(".mui-input-row input").val();
			if(mobile.length == 11 && $.trim($(".sendVer").text())=='获取验证码') {
				$.ajax({
					type: "post",
					url: IP + "/mobile/userSendMsg",
					data: {
						phone: mobile
					},
					dataType:"json",
					success: function(data) {
						if(data.result == 'success') {
							plus.nativeUI.toast("验证码已发送");
				            countdown = setInterval(CountDown, 1000); 	
						} else {
							plus.nativeUI.alert(data.result, function() {}, "出错了", "知道了")
						}
					},error:function(){
						plus.nativeUI.toast("验证码已发送");
			            countdown = setInterval(CountDown, 1000);
					}
				});
			}
			var count = 60;
			function CountDown() {
                $(".sendVer").html( count + " s");
                $(".sendVer").css("background","darkgrey");
                if (count == 0) {
                	$(".sendVer").html("重新发送");
                    clearInterval(countdown);
                     $(".sendVer").css("background","#6BBB55");
                     count=60;
                }
                count--;
            }
            if($.trim($(".sendVer").text())=='重新发送'){
         		$.ajax({
					type:"post",
					url:IP+"/mobile/userSendMsg",
					data:{phone: mobile},
					dataType:'json',
					success:function (data) {
						var result=data.result;
						if(result=='success'){
							plus.nativeUI.toast( "验证码已重新发送!");
							var countdo = setInterval(CountDown, 1000); 
						}
					},error:function(){
						plus.nativeUI.toast("验证码已发送");
			            countdown = setInterval(CountDown, 1000);
					}
				});
			}
            if($.trim($(".sendVer").text())!='重新发送' && mobile.length == 11 && $.trim($(".sendVer").text())!='获取验证码'){
            	plus.nativeUI.toast("验证码一分钟内不能重新发送");
            }
		});
		
		$(".phoneYanZheng_ver input").bind("input oninput",function(){
			var value = $(".mui-input-row input").val();
			var ph = value.length;
			var ver = $(".phoneYanZheng_ver input").val();
			var vlen = ver.length;
			if(ph == 11 && vlen!=0) {
				$(".click_sure").css("background", "#6bbb55");
			} else {
				$(".click_sure").css("background", "#DDDDDD");
			}
		})
		$(".click_sure").click(function() {
			var value = $(".mui-input-row input").val();
			var ph = value.length;
			var ver = $(".phoneYanZheng_ver input").val();
			var verlen =ver.length;
			if(verlen == null || verlen == 0){
				plus.nativeUI.toast("请输入验证码");
				return false;
			}
			if(ph == null || ph != 11 || isNaN(value)){
				plus.nativeUI.toast("请输入正确的手机号");
				return false;
			}

			var w = plus.nativeUI.showWaiting();
			var clientid = plus.push.getClientInfo().clientid;
			$.ajax({
				type:"post",
				url:IP+"/mobile/verificationCheck2",
				data:{
					phone:value,
					verificationCode:ver,
					clientid:clientid
				},
				dataType:"json",
				success:function(data){
					plus.storage.setItem("username",value);
					var result=data.result;
					if(result=='success'){
						plus.storage.setItem("login","true");
						plus.storage.setItem("phone",value);
						mui.preload({
						    url: "menu.html",
							id: "menu.html"
						});
						var webview = plus.webview.getWebviewById("menu.html");
						mui.fire(webview, "loginReflash");
						mui.preload({
						    url: "wallet.html",
							id: "wallet.html",
						});
//						mui.preload({
//						    url: "notification.html",
//							id: "notification.html",
//						});
						mui.preload({
						    url: "invite.html",
							id: "invite.html",
						});
						mui.preload({
						    url: "depositPay.html",
							id: "depositPay.html",
						});
//						mui.preload({
//						    url: "guide.html",
//							id: "guide.html",
//						});
						mui.preload({
						    url: "setting.html",
							id: "setting.html",
						});
						plus.webview.close(plus.webview.getWebviewById("walletHistory.html"));
						mui.preload({
						    url: "walletHistory.html",
							id: "walletHistory.html"
						});
					
						goPage("menu.html");
					}
					else{
						plus.nativeUI.alert(result, function() {
							console.log("User pressed!");
						}, "出错了", "知道了")
					}
					w.close();
				},error:function(){
					w.close();
					plus.nativeUI.alert(">.< 网络不给力");
				}
			});
		});
		
		function goPage(page) {
			mui.openWindow({
				url: page,
				id: page
			});
		}
	</script>
</html>